# üõ°Ô∏è Anti-Fraud Service

Servicio de an√°lisis anti-fraude en tiempo real para transacciones financieras, desarrollado con .NET 8 y AWS Lambda.

## üìã Caracter√≠sticas

- ‚úÖ **An√°lisis en tiempo real** de transacciones
- ‚úÖ **Reglas de detecci√≥n de fraude** configurables
- ‚úÖ **Integraci√≥n con Kafka** para eventos
- ‚úÖ **Base de datos PostgreSQL** con Entity Framework Core
- ‚úÖ **API REST** completa con documentaci√≥n OpenAPI
- ‚úÖ **Background services** para procesamiento as√≠ncrono
- ‚úÖ **Logging estructurado** para auditor√≠a
- ‚úÖ **Patr√≥n ResponseBuilder** para respuestas consistentes

## üèóÔ∏è Arquitectura

El servicio sigue una arquitectura limpia (Clean Architecture) con las siguientes capas:

```
‚îú‚îÄ‚îÄ üìÅ Domain/           # Entidades y reglas de negocio
‚îú‚îÄ‚îÄ üìÅ Application/      # Casos de uso y DTOs
‚îú‚îÄ‚îÄ üìÅ Infrastructure/   # Persistencia y servicios externos
‚îî‚îÄ‚îÄ üìÅ Lambda/          # Punto de entrada (AWS Lambda + HTTP Server)
```

### Componentes principales:

- **FraudAnalysisService**: Motor de an√°lisis de fraude
- **KafkaConsumerService**: Consumidor de eventos de transacciones
- **KafkaService**: Productor de eventos de estado
- **TransactionDayRepository**: Gesti√≥n de totales diarios

## üöÄ Configuraci√≥n r√°pida

### Prerrequisitos

- .NET 8 SDK
- PostgreSQL
- Kafka (Confluent Cloud o local)
- Docker (opcional)

### Variables de entorno

```bash
# Base de datos
ConnectionStrings__DefaultConnection="Host=localhost;Port=5432;Database=antifrauddb;Username=postgres;Password=misql"

# Kafka
Kafka__BootstrapServers="localhost:9092"
Kafka__TransactionEventsTopic="transaction-events"
Kafka__TransactionStatusEventsTopic="transaction-status-events"
Kafka__GroupId="fraud-service-group"

# Logging
Logging__LogLevel__Default="Information"
Logging__LogLevel__Microsoft="Warning"
```

### Instalaci√≥n y ejecuci√≥n

1. **Clonar el repositorio**
   ```bash
   git clone https://github.com/garciav999/FraudService.git
   cd FraudService
   ```

2. **Restaurar dependencias**
   ```bash
   dotnet restore
   ```

3. **Configurar base de datos PostgreSQL**
   
   **Opci√≥n A: Usando PostgreSQL local**
   ```sql
   -- Conectar a PostgreSQL como superusuario
   psql -U postgres
   
   -- ============================================
   -- CREAR BASE DE DATOS: antifrauddb
   -- ============================================
   CREATE DATABASE antifrauddb;
   \c antifrauddb;
   
   -- ============================================
   -- TABLA: TransactionDay
   -- ============================================
   CREATE TABLE IF NOT EXISTS "TransactionDay" (
       "TransactionDayId" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
       "TransactionDate" DATE NOT NULL,
       "SourceAccountId" UUID NOT NULL,
       "TotalValue" NUMERIC(12,2) NOT NULL DEFAULT 0,
       "UpdatedAt" TIMESTAMP NOT NULL DEFAULT NOW(),
       CONSTRAINT uq_transactionday UNIQUE ("TransactionDate", "SourceAccountId")
   );
   
   COMMENT ON TABLE "TransactionDay" IS 'Acumulado diario de transacciones por cuenta para validaciones antifraude.';
   COMMENT ON COLUMN "TransactionDay"."TotalValue" IS 'Monto total acumulado en el d√≠a por la cuenta origen.';
   COMMENT ON COLUMN "TransactionDay"."TransactionDate" IS 'Fecha de las transacciones agrupadas.';
   
   -- Crear √≠ndices para optimizaci√≥n
   CREATE INDEX IF NOT EXISTS idx_transactionday_account_date 
       ON "TransactionDay" ("SourceAccountId", "TransactionDate");
   ```
   
   **Opci√≥n B: Usando Entity Framework Migrations**
   ```bash
   cd app/src/Infrastructure
   dotnet ef database update
   ```

4. **Ejecutar el servicio**
   ```bash
   cd app/src/Lambda
   dotnet run
   ```

5. **Acceder a la aplicaci√≥n**
   - HTTP Server: `http://localhost:5051`
   - Swagger UI: `http://localhost:5051/swagger` (si est√° configurado)

### Con Docker

```bash
cd app
docker-compose up -d
```

## üìö API Endpoints

| M√©todo | Endpoint | Descripci√≥n |
|--------|----------|-------------|
| `POST` | `/analyze-fraud` | Analizar transacci√≥n para detecci√≥n de fraude |
| `POST` | `/upsert-transaction-day` | Crear/actualizar total diario |
| `POST` | `/start-kafka-consumer` | Iniciar consumidor Kafka manualmente |
| `GET`  | `/health` | Estado de salud del servicio |

### Ejemplo de an√°lisis de fraude

```bash
curl -X POST http://localhost:5051/analyze-fraud \
  -H "Content-Type: application/json" \
  -d '{
    "transactionExternalId": "550e8400-e29b-41d4-a716-446655440001",
    "sourceAccountId": "11111111-1111-1111-1111-111111111111",
    "targetAccountId": "22222222-2222-2222-2222-222222222222",
    "transferTypeId": 1,
    "value": 1500.00,
    "status": "Pending",
    "id": "550e8400-e29b-41d4-a716-446655440002",
    "occurredAt": "2025-10-24T14:30:00Z",
    "eventType": "transaction.created"
  }'
```

**Respuesta de transacci√≥n aprobada:**
```json
{
  "success": true,
  "data": {
    "isApproved": true,
    "reason": "Transaction approved",
    "riskScore": 0,
    "riskFactors": []
  },
  "message": "Fraud analysis completed successfully",
  "error": null,
  "timestamp": "2025-10-24T14:30:00Z"
}
```

## üîç Reglas de detecci√≥n de fraude

### Reglas actuales:

1. **L√≠mite individual**: Transacciones > $2,500 son rechazadas
2. **L√≠mite diario**: Total diario por cuenta > $20,500 es rechazado

### Configuraci√≥n de reglas:

Las reglas est√°n definidas en `FraudAnalysisService.cs` y pueden ser configuradas mediante:

```csharp
private const decimal INDIVIDUAL_LIMIT = 2500m;
private const decimal DAILY_LIMIT = 20500m;
```

## üîÑ Flujo de eventos Kafka

### Topics utilizados:

- **`transaction-events`** (entrada): Eventos de transacciones creadas
- **`transaction-status-events`** (salida): Resultados del an√°lisis

### Estructura de eventos:

**Evento de entrada (TransactionCreatedEvent):**
```json
{
  "TransactionExternalId": "uuid",
  "SourceAccountId": "uuid",
  "TargetAccountId": "uuid", 
  "TransferTypeId": 1,
  "Value": 1500.00,
  "Status": "Pending",
  "Id": "uuid",
  "OccurredAt": "2025-10-24T14:30:00Z",
  "EventType": "transaction.created"
}
```

**Evento de salida (TransactionStatusEvent):**
```json
{
  "TransactionExternalId": "uuid",
  "Status": "Approved",
  "Reason": "Transaction approved",
  "ProcessedAt": "2025-10-24T14:30:01Z"
}
```

## üóÑÔ∏è Base de datos

### Esquema de la base de datos

La aplicaci√≥n utiliza **PostgreSQL** como base de datos principal para almacenar los totales diarios de transacciones.

#### Tabla TransactionDay

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `TransactionDayId` | UUID | Identificador √∫nico (Primary Key) |
| `SourceAccountId` | UUID | ID de la cuenta origen |
| `TransactionDate` | DATE | Fecha de la transacci√≥n (solo fecha, sin hora) |
| `TotalValue` | NUMERIC(12,2) | Total acumulado del d√≠a |
| `UpdatedAt` | TIMESTAMP | Fecha de √∫ltima actualizaci√≥n |

#### Restricciones y √≠ndices

```sql
-- Constraint √∫nico para evitar duplicados
CONSTRAINT uq_transactionday UNIQUE ("TransactionDate", "SourceAccountId")

-- √çndice optimizado para consultas frecuentes
CREATE INDEX idx_transactionday_account_date 
    ON "TransactionDay" ("SourceAccountId", "TransactionDate");
```

### Script de creaci√≥n manual

Si prefieres crear la base de datos manualmente en lugar de usar Entity Framework:

```sql
-- ============================================
-- CREAR BASE DE DATOS: antifrauddb
-- ============================================
CREATE DATABASE antifrauddb;
\c antifrauddb;

-- ============================================
-- TABLA: TransactionDay
-- ============================================
CREATE TABLE IF NOT EXISTS "TransactionDay" (
    "TransactionDayId" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "TransactionDate" DATE NOT NULL,
    "SourceAccountId" UUID NOT NULL,
    "TotalValue" NUMERIC(12,2) NOT NULL DEFAULT 0,
    "UpdatedAt" TIMESTAMP NOT NULL DEFAULT NOW(),
    CONSTRAINT uq_transactionday UNIQUE ("TransactionDate", "SourceAccountId")
);

COMMENT ON TABLE "TransactionDay" IS 'Acumulado diario de transacciones por cuenta para validaciones antifraude.';
COMMENT ON COLUMN "TransactionDay"."TotalValue" IS 'Monto total acumulado en el d√≠a por la cuenta origen.';
COMMENT ON COLUMN "TransactionDay"."TransactionDate" IS 'Fecha de las transacciones agrupadas.';

-- Crear √≠ndices para optimizaci√≥n
CREATE INDEX IF NOT EXISTS idx_transactionday_account_date 
    ON "TransactionDay" ("SourceAccountId", "TransactionDate");
```

### Configuraci√≥n de conexi√≥n

Aseg√∫rate de que tu `appsettings.json` contenga la cadena de conexi√≥n correcta:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=antifrauddb;Username=postgres;Password=misql"
  }
}
```

### Entity Framework Migrations

Si prefieres usar migraciones de Entity Framework:

```bash
# Crear migraci√≥n
cd app/src/Infrastructure
dotnet ef migrations add InitialCreate

# Aplicar migraciones
dotnet ef database update

# Verificar migraci√≥n
dotnet ef migrations list
```

## üß™ Testing

### Ejecutar tests unitarios

```bash
cd tests
dotnet test
```

### Testing manual

El servicio incluye un servidor HTTP para testing manual de endpoints.

## üìä Monitoreo y Logging

### Logs estructurados

El servicio utiliza logging estructurado para facilitar el monitoreo:

```csharp
_logger.LogInformation("Fraud analysis completed for transaction {TransactionId} with result {IsApproved}", 
    transactionId, result.IsApproved);
```

### M√©tricas importantes

- Transacciones procesadas por minuto
- Porcentaje de transacciones rechazadas
- Tiempo promedio de an√°lisis
- Estado del consumidor Kafka

## üîß Desarrollo

### Estructura del proyecto

```
FraudService/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ   ‚îú‚îÄ‚îÄ FraudService.sln
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ Domain/              # Entidades de dominio
‚îÇ       ‚îú‚îÄ‚îÄ Application/         # Casos de uso y DTOs
‚îÇ       ‚îú‚îÄ‚îÄ Infrastructure/      # Persistencia y servicios
‚îÇ       ‚îî‚îÄ‚îÄ Lambda/             # Punto de entrada
‚îú‚îÄ‚îÄ tests/                      # Tests unitarios
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ openapi.yml            # Documentaci√≥n API
‚îÇ   ‚îî‚îÄ‚îÄ sequence-diagram.md    # Diagrama de secuencia
‚îî‚îÄ‚îÄ README.md
```

### Convenciones de c√≥digo

- Utilizar `PascalCase` para clases y m√©todos p√∫blicos
- Utilizar `camelCase` para variables locales
- Incluir logging para operaciones importantes
- Manejar excepciones apropiadamente
- Seguir principios SOLID

### Agregar nuevas reglas de fraude

1. Extender `IFraudAnalysisService`
2. Implementar l√≥gica en `FraudAnalysisService`
3. Agregar tests unitarios
4. Actualizar documentaci√≥n

## üöÄ Deployment

### AWS Lambda

El servicio est√° configurado para ejecutarse como AWS Lambda:

```bash
# Publicar a AWS
dotnet lambda deploy-function
```

### Configuraci√≥n de producci√≥n

- Configurar variables de entorno en AWS
- Establecer pol√≠ticas IAM apropiadas
- Configurar VPC para acceso a base de datos
- Configurar CloudWatch para logs

## ü§ù Contribuci√≥n

1. Fork el proyecto
2. Crear una rama para tu feature (`git checkout -b feature/nueva-regla`)
3. Commit tus cambios (`git commit -am 'Agregar nueva regla de fraude'`)
4. Push a la rama (`git push origin feature/nueva-regla`)
5. Crear un Pull Request

## üìù Licencia

Este proyecto est√° bajo la Licencia MIT. Ver `LICENSE` para m√°s detalles.

## üÜò Soporte

Para soporte y preguntas:

- üìß Email: antifraud@company.com
- üêõ Issues: [GitHub Issues](https://github.com/garciav999/FraudService/issues)
- üìö Documentaci√≥n: Ver `/docs/openapi.yml`

---

‚≠ê **¬°Dale una estrella si este proyecto te fue √∫til!**
